<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="세무그룹 잇다의 공지사항 - 세무 관련 소식과 공지를 확인하세요.">
    <title>공지사항 | 세무그룹 잇다</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 헤더 플레이스홀더 -->
    <div id="header-placeholder"></div>

    <!-- 페이지 히어로 -->
    <section class="page-hero">
        <div class="container">
            <div class="page-hero-content">
                <h1>공지사항</h1>
                <p>세무그룹 잇다의 소식과 세무 관련 정보를 안내합니다</p>
                <div class="breadcrumb">
                    <a href="index.html">홈</a>
                    <span>/</span>
                    <span>공지사항</span>
                </div>
            </div>
        </div>
    </section>

    <!-- 공지사항 목록 -->
    <section class="section">
        <div class="container">
            <div class="notice-list" id="noticeList">
                <div class="notice-empty" id="noticeLoading">공지사항을 불러오는 중...</div>
            </div>

            <!-- 페이지네이션 -->
            <div class="pagination" id="pagination"></div>
        </div>
    </section>

    <!-- 푸터 플레이스홀더 -->
    <div id="footer-placeholder"></div>

    <script src="common.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        // 페이지 설정
        const NOTICES_PER_PAGE = 8;
        let currentPage = 1;
        let allNotices = [];

        // 카테고리 → CSS 클래스 매핑
        function getCategoryClass(category) {
            const map = { '이벤트': 'event', '업데이트': 'update' };
            return map[category] || '';
        }

        // HTML 이스케이프 (XSS 방지)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 공지사항 HTML 생성
        function renderNoticeItem(notice) {
            const categoryClass = getCategoryClass(notice.category);
            return `
                <div class="notice-item fade-in visible">
                    <span class="notice-category ${categoryClass}">${escapeHtml(notice.category)}</span>
                    <div class="notice-content">
                        <h3 class="notice-title">${escapeHtml(notice.title)}</h3>
                        <p class="notice-excerpt">${escapeHtml(notice.excerpt)}</p>
                    </div>
                    <span class="notice-date">${escapeHtml(notice.date)}</span>
                </div>
            `;
        }

        // 목록 렌더링
        function renderNotices(page) {
            const list = document.getElementById('noticeList');
            const start = (page - 1) * NOTICES_PER_PAGE;
            const end = start + NOTICES_PER_PAGE;
            const pageNotices = allNotices.slice(start, end);

            if (pageNotices.length === 0) {
                list.innerHTML = '<div class="notice-empty">등록된 공지사항이 없습니다.</div>';
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            list.innerHTML = pageNotices.map(renderNoticeItem).join('');
            renderPagination(page);
        }

        // 페이지네이션 렌더링
        function renderPagination(page) {
            const totalPages = Math.ceil(allNotices.length / NOTICES_PER_PAGE);
            const paginationEl = document.getElementById('pagination');

            if (totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let html = '';

            // 이전 버튼
            html += `<a href="#" onclick="goToPage(${page - 1}); return false;"
                        ${page === 1 ? 'style="opacity:0.3;pointer-events:none"' : ''}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M15 19l-7-7 7-7"/>
                        </svg></a>`;

            // 페이지 번호
            for (let i = 1; i <= totalPages; i++) {
                if (i === page) {
                    html += `<span class="active">${i}</span>`;
                } else {
                    html += `<a href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
                }
            }

            // 다음 버튼
            html += `<a href="#" onclick="goToPage(${page + 1}); return false;"
                        ${page === totalPages ? 'style="opacity:0.3;pointer-events:none"' : ''}>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M9 5l7 7-7 7"/>
                        </svg></a>`;

            paginationEl.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            renderNotices(page);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Firestore에서 공지사항 불러오기
        async function loadNotices() {
            try {
                const snapshot = await db.collection('notices')
                    .orderBy('createdAt', 'desc')
                    .get();

                allNotices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                renderNotices(1);
            } catch (error) {
                console.error('공지사항 로드 실패:', error);
                document.getElementById('noticeList').innerHTML =
                    '<div class="notice-empty">공지사항을 불러오는데 실패했습니다.</div>';
            }
        }

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', loadNotices);
    </script>
</body>
</html>
